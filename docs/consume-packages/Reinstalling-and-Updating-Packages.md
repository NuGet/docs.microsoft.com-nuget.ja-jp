---
title: NuGet パッケージの再インストールと更新
description: パッケージをいつ更新して再インストールする必要があるのかに関する詳細と、壊れた Visual Studio のパッケージ参照について。
author: karann-msft
ms.author: karann
ms.date: 12/07/2017
ms.topic: conceptual
ms.openlocfilehash: c48980bc3f955a62962ca6e9619ce09f4a94a835
ms.sourcegitcommit: 7441f12f06ca380feb87c6192ec69f6108f43ee3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/15/2019
ms.locfileid: "69488077"
---
# <a name="how-to-reinstall-and-update-packages"></a>パッケージを再インストールし更新する方法

以下の「[パッケージを再インストールするタイミング](#when-to-reinstall-a-package)」で説明しているとおり、Visual Studio のプロジェクトでは、パッケージへの参照が壊れてしまう状況が多々あります。 このような場合、パッケージの同じバージョンをアンインストールして再インストールすると、それらの参照は復元され動作するようになります。 パッケージを更新するということは、単純に更新されたバージョンをインストールすることを意味し、これによってパッケージはしばしば動作する状態に復元されます。

Visual Studio のパッケージ マネージャー コンソールには、パッケージの更新と再インストールを行うための柔軟なオプションが多数用意されています。

パッケージの更新と再インストールは次の順序で行います。

| メソッド | 更新 | 再インストール |
| --- | --- | --- |
| パッケージ マネージャー コンソール (「[Update-Package の使用](#using-update-package)」を参照) | `Update-Package` コマンド | `Update-Package -reinstall` コマンド |
| パッケージ マネージャー UI | **[更新]** タブで、1 つ以上のパッケージを選択し、 **[更新]** を選択します。 | **[インストール]** タブで、パッケージを選択し、その名前を書き留め、 **[アンインストール]** を選択します。 **[参照]** タブに切り替え、パッケージ名を検索して選択し、 **[インストール]** を選択します。 |
| nuget.exe CLI | `nuget update` コマンド | すべてのパッケージで、パッケージ フォルダーを削除し、`nuget install` を実行します。 1 つのパッケージで、パッケージ フォルダーを削除し、`nuget install <id>` を使用して同じものを再インストールします。 |

> [!NOTE]
> dotnet CLI では、同等のプロシージャは必要ありません。 同様のシナリオで、[dotnet CLI を使用してパッケージを復元](package-restore.md#restore-using-the-dotnet-cli)できます。

この記事の内容:

- [パッケージを再インストールするタイミング](#when-to-reinstall-a-package)
- [アップグレード バージョンを制限する](#constraining-upgrade-versions)

## <a name="when-to-reinstall-a-package"></a>パッケージを再インストールするタイミング

1. **パッケージの復元後に参照が壊れた場合**: プロジェクトを開いて NuGet パッケージを復元しても、引き続き参照が壊れている場合、それらのパッケージをそれぞれ再インストールしてみてください。
1. **ファイルを削除したためにプロジェクトが壊れた場合**: NuGet によって、ユーザーがパッケージから追加されたアイテムを削除できなくされることはありません。したがって、パッケージからインストールされたコンテンツを不注意に簡単に変更できてしまい、プロジェクトを壊すことができます。 プロジェクトを復元するには、影響を受けたパッケージを再インストールします。
1. **パッケージの更新によりプロジェクトが壊れた場合**: パッケージを更新してプロジェクトが壊れた場合、一般的に障害は更新された可能性がある依存関係パッケージによって起こります。 依存関係の状態を復元するには、その特定のパッケージを再インストールします。
1. **プロジェクトの再ターゲットまたはアップグレードの場合**: これは、プロジェクトが再ターゲットされたかアップグレードされた場合、ターゲット フレームワークの変更のためにパッケージを再インストールする必要がある場合に便利です。 NuGet では、このような場合、プロジェクトの再ターゲット後に直ちにビルド エラーが表示されます。そしてその後のビルド警告により、パッケージを再インストールする必要がある場合があることが通知されます。 プロジェクトをアップグレードする必要がある場合、NuGet では、プロジェクトのアップグレード ログにエラーが表示されます。
1. **開発時にパッケージを再インストールする場合**: パッケージ作成者は、動作をテストするために、開発しているパッケージの同じバージョンを再インストールする必要があることがよくあります。 `Install-Package` コマンドには再インストールを強制するオプションがないので、代わりに `Update-Package -reinstall` を使用します。

## <a name="constraining-upgrade-versions"></a>アップグレード バージョンを制限する

既定では、パッケージを再インストールまたは更新した場合、パッケージ ソースから使用可能な最新バージョンが*常に*インストールされます。

ただし、`packages.config` 管理形式を使用するプロジェクトでは、バージョン範囲を具体的に制限することができます。 たとえば、恐らくはパッケージ API の大幅な変更により、アプリケーションがパッケージのバージョン 2.0 以上では機能せず、1.x のみで機能することがわかっている場合、バージョン 1.x にアップグレードすることに制限したいとします。 これにより、偶発的に更新されることにより、アプリケーションが機能しなくなってしまうことを避けることができます。

制限を設定するには、テキスト エディターで `packages.config` を開き、問題の依存関係を探し、バージョン範囲と共に `allowedVersions` 属性を追加します。 たとえば、更新をバージョン 1.x に制限する場合、`allowedVersions` を `[1,2)` に設定します。

```xml
<?xml version="1.0" encoding="utf-8"?>
<packages>
    <package id="ExamplePackage" version="1.1.0" allowedVersions="[1,2)" />

    <!-- ... -->
</packages>
```

いずれの場合も、「[Package versioning](../concepts/package-versioning.md#version-ranges-and-wildcards)」(パッケージのバージョン管理) で説明されている表記を使います。

## <a name="using-update-package"></a>Update-Package の使用

以下の「[注意事項](#considerations)」を考慮しながら、Visual Studio パッケージ マネージャー コンソール ( **[ツール]**  >  **[NuGet パッケージ マネージャー]**  >  **[パッケージ マネージャー コンソール]** ) の [[Update-Package コマンド]](../reference/ps-reference/ps-ref-update-package.md) を使用して、すべてのパッケージを簡単に再インストールできます。

```ps
Update-Package -Id <package_name> –reinstall
```

このコマンドの使用は、パッケージを削除し、NuGet ギャラリーで同じバージョンの同じパッケージを探すよりもはるかに簡単です。 なお、`-Id` スイッチは省略可能です。

`-reinstall` なしの同じコマンドでは、存在する場合、パッケージがより新しいバージョンに更新されます。 問題のパッケージがプロジェクトにまだインストールされていない場合、このコマンドによってエラーが表示されます。つまり、`Update-Package` でパッケージが直接インストールされません。

```ps
Update-Package <package_name>
```

既定では、`Update-Package` はソリューション内のすべてのプロジェクトに影響します。 特定のプロジェクトにアクションを制限するには、ソリューション エクスプローラーに表示されるプロジェクト名を使用し、`-ProjectName` スイッチを使用します。

```ps
# Reinstall the package in just MyProject
Update-Package <package_name> -ProjectName MyProject -reinstall
```

プロジェクトのすべてのパッケージを*更新*するには (または `-reinstall` を使用して再インストールするには)、特定のパッケージを指定せずに `-ProjectName` を使用します。

```ps
Update-Package -ProjectName MyProject
```

ソリューション内のすべてのパッケージを更新するには、`Update-Package` を他の引数やスイッチなしで単体で使用します。 すべての更新を行うには、かなり時間がかかるため、このフォームは慎重に使用してください。

```ps
# Updates all packages in all projects in the solution
Update-Package 
```

[PackageReference](../Consume-Packages/Package-References-in-Project-Files.md)を使用してプロジェクトまたはソリューションのパッケージを更新する場合、パッケージは常に最新バージョンに更新されます (リリース前のパッケージは除きます)。 プロジェクトで `packages.config` を使用している場合、必要に応じて、以下の「[アップグレード バージョンを制限する](#constraining-upgrade-versions)」で説明するとおり、更新バージョンを制限できます。

完全なコマンドについては、「[Update-Package](../reference/ps-reference/ps-ref-update-package.md)」を参照してください。

### <a name="considerations"></a>注意事項

パッケージを再インストールする場合、以下の影響がある場合があります。

1. **プロジェクト ターゲット フレームワークの再ターゲットに従ったパッケージの再インストール**
    - 単純なケースでは、`Update-Package –reinstall <package_name>` を使用してパッケージを再インストールするたけで機能します。 古いターゲット フレームワークに対してインストールされたパッケージは、アンインストールされ、同じパッケージがそのプロジェクトの現在のターゲット フレームワークに対してインストールされます。
    - パッケージで、新しいターゲット フレームワークがサポートされない場合もあります。
        - パッケージがポータブル クラス ライブラリ (PCL) をサポートし、プロジェクトがパッケージがサポートしなくなったプラットフォームの組み合わせに再ターゲットされている場合、パッケージへの参照は再インストール後に失われます。
        - これは直接使用しているパッケージまたは依存関係でインストールされたパッケージで生じます。 その依存関係はサポートしない場合でも、使用しているパッケージで、新しいターゲット フレームワークを直接サポートさせることは可能です。
        - アプリケーションの再ターゲット後にパッケージを再インストールすることによって、ビルド エラーまたはランタイム エラーが発生する場合、ターゲット フレームワークを元に戻すか、新しいターゲット フレームワークを正しくサポートする別のパッケージを探す必要があります。

1. **プロジェクトの再ターゲットまたはアップグレード後に、packages.config に requireReinstallation 属性が追加される**
    - NuGet によってプロジェクトの再ターゲットまたはアップグレードによってパッケージが影響を受けたと検出された場合、影響を受けたすべてのパッケージ参照の `packages.config` に `requireReinstallation="true"` 属性が追加されます。 このため、Visual Studio のそれ以降の各ビルドでは、再インストールすることを忘れないように、それらのパッケージでビルド警告が発せられます。

1. **依存関係と共にパッケージを再インストールする**
    - `Update-Package –reinstall` では元のパッケージの同じバージョンが再インストールされますが、依存関係は、特定のバージョン制限を指定しない限り、最新バージョンがインストールされます。 このため、問題を修正するには必要な依存関係のみを更新します。 ただし、これにより、依存関係が以前のバージョンにロールバックされる場合、依存パッケージには影響を与えずに、`Update-Package <dependency_name>` を使用して、その 1 つの依存関係のみを再インストールできます。
    - `Update-Package –reinstall <packageName> -ignoreDependencies` では、元のパッケージの同じバージョンが再インストールされますが、依存関係は再インストールされません。 パッケージの依存関係を更新したことによって壊れてしまう場合、これを使用してください。

1. **依存しているバージョンが含まれている場合にパッケージを再インストールする**
    - 上で説明したとおり、パッケージを再インストールしても、それに依存する他のインストールされているパッケージのバージョンは変わりません。 その場合、依存関係を再インストールした場合、依存パッケージが壊れてしまう場合があります。
