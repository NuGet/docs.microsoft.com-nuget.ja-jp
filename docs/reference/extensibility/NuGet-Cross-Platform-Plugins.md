---
title: NuGet クロスプラットフォームプラグイン
description: Nuget、dotnet、msbuild.exe、および Visual Studio 用の NuGet クロスプラットフォームプラグイン
author: nkolev92
ms.author: nikolev
ms.date: 07/01/2018
ms.topic: conceptual
ms.openlocfilehash: 74b80b1791dcb403c90bb3032c009717c11ffe57
ms.sourcegitcommit: 5a741f025e816b684ffe44a81ef7d3fbd2800039
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/09/2019
ms.locfileid: "70815306"
---
# <a name="nuget-cross-platform-plugins"></a>NuGet クロスプラットフォームプラグイン

NuGet 4.8 以降では、クロスプラットフォームプラグインのサポートが追加されています。
これは、新しいプラグイン拡張モデルを構築することで実現されました。これは、厳密な一連の操作規則に準拠する必要があります。
プラグインは自己完結型の実行可能ファイルであり、NuGet クライアントは別のプロセスで起動されます。
これは、1回の書き込みで、すべてのプラグインを実行します。 これは、すべての NuGet クライアントツールで動作します。
プラグインには、.NET Framework (Nuget.exe、Msbuild.exe、Visual Studio)、または .NET Core (dotnet) のいずれかを指定できます。
NuGet クライアントとプラグインの間のバージョン付き通信プロトコルが定義されています。 スタートアップハンドシェイク中、2つのプロセスがプロトコルのバージョンをネゴシエートします。

すべての NuGet クライアントツールのシナリオに対応するために、.NET Framework と .NET Core プラグインの両方が必要です。
次に、プラグインのクライアントとフレームワークの組み合わせについて説明します。

| クライアント ツール  | Framework |
| ------------ | --------- |
| Visual Studio | .NET Framework |
| dotnet | .NET Core |
| Nuget.exe | .NET Framework |
| Msbuild.exe | .NET Framework |
| Mono での Nuget.exe | .NET Framework |

## <a name="how-does-it-work"></a>動作のしくみ

高レベルのワークフローは、次のように記述できます。

1. NuGet は、使用可能なプラグインを検出します。
1. 該当する場合、NuGet はプラグインを優先順位に従って繰り返し処理し、1つずつ開始します。
1. NuGet は、要求を処理できる最初のプラグインを使用します。
1. プラグインは、不要になったときにシャットダウンされます。

## <a name="general-plugin-requirements"></a>一般的なプラグインの要件

現在のプロトコルバージョンは*2.0.0*です。
このバージョンでは、次の要件があります。

- Windows と Mono で実行される、信頼された有効な Authenticode 署名アセンブリを用意します。 Linux および Mac でのアセンブリの実行には、特別な信頼要件はありません。 [関連する問題](https://github.com/NuGet/Home/issues/6702)
- NuGet クライアントツールの現在のセキュリティコンテキストでのステートレス起動をサポートします。 たとえば、NuGet クライアントツールでは、後で説明するプラグインプロトコルの外部での昇格や追加の初期化は実行されません。
- 明示的に指定されている場合を除き、非対話型にします。
- ネゴシエートされたプラグインプロトコルのバージョンに準拠します。
- 妥当な期間内にすべての要求に応答します。
- 進行中の操作のキャンセル要求を優先します。

技術仕様の詳細については、次の仕様を参照してください。

- [NuGet パッケージのダウンロードプラグイン](https://github.com/NuGet/Home/wiki/NuGet-Package-Download-Plugin)
- [NuGet のクロスプラットフォーム認証プラグイン](https://github.com/NuGet/Home/wiki/NuGet-cross-plat-authentication-plugin)

## <a name="client---plugin-interaction"></a>クライアントとプラグインの相互作用

NuGet クライアントツールとプラグインは、標準ストリーム (stdin、stdout、stderr) を介して JSON と通信します。 すべてのデータは、UTF-8 でエンコードする必要があります。
プラグインは、引数 "-Plugin" を使用して起動されます。 ユーザーがこの引数を指定せずにプラグインの実行可能ファイルを直接起動した場合、プラグインは、プロトコルハンドシェイクを待機する代わりに、情報メッセージを提供できます。
プロトコルハンドシェイクタイムアウトは5秒です。 プラグインは、できるだけ少ない量でセットアップを完了する必要があります。
NuGet クライアントツールは、NuGet ソースのサービスインデックスを渡すことによって、プラグインのサポートされている操作に対してクエリを実行します。 プラグインでは、サービスインデックスを使用して、サポートされているサービスの種類が存在するかどうかを確認できます。

NuGet クライアントツールとプラグインの間の通信は双方向です。 各要求のタイムアウトは5秒です。 操作の実行時間が長くなることが予想される場合は、要求がタイムアウトしないように、各プロセスが進捗状況メッセージを送信する必要があります。1分の非アクティブな状態では、プラグインはアイドル状態と見なされ、シャットダウンされます。

## <a name="plugin-installation-and-discovery"></a>プラグインのインストールと検出

プラグインは、規則ベースのディレクトリ構造を使用して検出されます。
CI/CD のシナリオとパワーユーザーは、環境変数を使用して動作をオーバーライドできます。 `NUGET_NETFX_PLUGIN_PATHS` と`NUGET_NETCORE_PLUGIN_PATHS`は、5.3 以降のバージョンの NuGet ツールでのみ使用できます。

- `NUGET_NETFX_PLUGIN_PATHS`-.NET Framework ベースのツール (Nuget.exe/Msbuild.exe/Visual Studio) によって使用されるプラグインを定義します。 はより`NUGET_PLUGIN_PATHS`も優先されます。 (NuGet バージョン5.3 以降のみ)
- `NUGET_NETCORE_PLUGIN_PATHS`-.NET Core ベースのツール (dotnet) によって使用されるプラグインを定義します。 はより`NUGET_PLUGIN_PATHS`も優先されます。 (NuGet バージョン5.3 以降のみ)
- `NUGET_PLUGIN_PATHS`-その NuGet プロセスに使用されるプラグイン、優先順位予約済みのプラグインを定義します。 この環境変数が設定されている場合は、規則ベースの検出を上書きします。 フレームワーク固有の変数のいずれかが指定されている場合は無視されます。
-  ユーザー-場所 (の`%UserProfile%/.nuget/plugins`NuGet ホームの場所)。 この場所を上書きすることはできません。 .NET Core と .NET Framework プラグインには、別のルートディレクトリが使用されます。

| Framework | ルート探索場所  |
| ------- | ------------------------ |
| .NET Core |  `%UserProfile%/.nuget/plugins/netcore` |
| .NET Framework | `%UserProfile%/.nuget/plugins/netfx` |

各プラグインは、独自のフォルダーにインストールする必要があります。
プラグインのエントリポイントは、インストールされているフォルダーの名前になります。また、.NET Core の .dll 拡張子と .NET Framework の .exe 拡張子が使用されます。

```
.nuget
    plugins
        netfx
            myPlugin
                myPlugin.exe
                nuget.protocol.dll
                ...
        netcore
            myPlugin
                myPlugin.dll
                nuget.protocol.dll
                ...
```

> [!Note]
> 現在、プラグインをインストールするためのユーザーストーリーはありません。 これは、必要なファイルを事前に定義された場所に移動するだけの簡単な方法です。

## <a name="supported-operations"></a>サポートされる操作

新しいプラグインプロトコルでは、2つの操作がサポートされています。

| 操作名 | 最小プロトコルバージョン | 最小 NuGet クライアントバージョン |
| -------------- | ----------------------- | --------------------- |
| パッケージのダウンロード | 1.0.0 | 4.3.0 |
| [認証](NuGet-Cross-Platform-Authentication-Plugin.md) | 2.0.0 | 4.8.0 |

## <a name="running-plugins-under-the-correct-runtime"></a>正しいランタイムでのプラグインの実行

Dotnet シナリオの NuGet の場合、プラグインは dotnet の特定のランタイムで実行できる必要があります。
プラグインプロバイダーとコンシューマーが、互換性のある dotnet とプラグインの組み合わせが使用されていることを確認します。
ユーザー場所プラグインでは、たとえば、2.0 ランタイムの下にある dotnet が2.1 ランタイム用に記述されたプラグインを使用しようとすると、問題が発生する可能性があります。

## <a name="capabilities-caching"></a>機能のキャッシュ

プラグインのセキュリティ検証とインスタンス化はコストがかかります。 ダウンロード操作は認証操作よりも頻繁に行われますが、平均の NuGet ユーザーは認証プラグインを持つ可能性があるだけです。
エクスペリエンスを向上させるために、NuGet は指定された要求の操作要求をキャッシュします。 このキャッシュはプラグインごとに、プラグインキーはプラグインパス、この機能キャッシュの有効期限は30日です。 

キャッシュはに`%LocalAppData%/NuGet/plugins-cache`あり、環境変数`NUGET_PLUGINS_CACHE_PATH`でオーバーライドされます。 この[キャッシュ](../../consume-packages/managing-the-global-packages-and-cache-folders.md)をクリアするには、 `plugins-cache`オプションを指定してローカルコマンドを実行します。
[ `all`ローカル] オプションでは、プラグインキャッシュも削除されます。 

## <a name="protocol-messages-index"></a>プロトコルメッセージのインデックス

プロトコルバージョン*1.0.0*メッセージ:

1.  閉じる
    * 要求方向:NuGet-> プラグイン
    * 要求にペイロードが含まれていません
    * 応答は必要ありません。  適切な応答は、プラグインプロセスがすぐに終了するためです。

2.  パッケージ内のファイルをコピーする
    * 要求方向:NuGet-> プラグイン
    * 要求には次のものが含まれます。
        * パッケージ ID とバージョン
        * パッケージソースリポジトリの場所
        * 宛先ディレクトリのパス
        * コピー先のディレクトリパスにコピーするパッケージ内のファイルの列挙
    * 応答には次のものが含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合にコピー先ディレクトリにコピーされたファイルの完全パスを列挙可能

3.  パッケージファイルのコピー (. nupkg)
    * 要求方向:NuGet-> プラグイン
    * 要求には次のものが含まれます。
        * パッケージ ID とバージョン
        * パッケージソースリポジトリの場所
        * コピー先のファイルパス
    * 応答には次のものが含まれます。
        * 操作の結果を示す応答コード

4.  資格情報の取得
    * 要求方向: プラグイン-> NuGet
    * 要求には次のものが含まれます。
        * パッケージソースリポジトリの場所
        * 現在の資格情報を使用してパッケージソースリポジトリから取得した HTTP ステータスコード
    * 応答には次のものが含まれます。
        * 操作の結果を示す応答コード
        * ユーザー名 (使用可能な場合)
        * パスワード (使用可能な場合)

5.  パッケージ内のファイルを取得する
    * 要求方向:NuGet-> プラグイン
    * 要求には次のものが含まれます。
        * パッケージ ID とバージョン
        * パッケージソースリポジトリの場所
    * 応答には次のものが含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合のパッケージ内のファイルパスの列挙。

6.  操作要求の取得 
    * 要求方向:NuGet-> プラグイン
    * 要求には次のものが含まれます。
        * パッケージソースのサービスインデックス。
        * パッケージソースリポジトリの場所
    * 応答には次のものが含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合の、サポートされている操作 (例: パッケージのダウンロード) の列挙。  プラグインでパッケージソースがサポートされていない場合、プラグインはサポートされている操作の空のセットを返す必要があります。

> [!Note]
> このメッセージは、バージョン*2.0.0*で更新されました。 旧バージョンとの互換性を維持するために、クライアント上にあります。

7.  パッケージハッシュの取得
    * 要求方向:NuGet-> プラグイン
    * 要求には次のものが含まれます。
        * パッケージ ID とバージョン
        * パッケージソースリポジトリの場所
        * ハッシュアルゴリズム
    * 応答には次のものが含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合は、要求されたハッシュアルゴリズムを使用したパッケージファイルハッシュ

8.  パッケージのバージョンを取得する
    * 要求方向:NuGet-> プラグイン
    * 要求には次のものが含まれます。
        * パッケージ ID
        * パッケージソースリポジトリの場所
    * 応答には次のものが含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合のパッケージバージョンの列挙可能な

9.  サービスインデックスの取得
    * 要求方向: プラグイン-> NuGet
    * 要求には次のものが含まれます。
        * パッケージソースリポジトリの場所
    * 応答には次のものが含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合のサービスインデックス

10.  ハンドシェイク
     * 要求方向:NuGet <-> プラグイン
     * 要求には次のものが含まれます。
         * 現在のプラグインプロトコルのバージョン
         * サポートされている最小プラグインプロトコルバージョン
     * 応答には次のものが含まれます。
         * 操作の結果を示す応答コード
         * 操作が成功した場合は、ネゴシエートされたプロトコルバージョン。  エラーが発生すると、プラグインが終了します。

11.  Initialize
     * 要求方向:NuGet-> プラグイン
     * 要求には次のものが含まれます。
         * NuGet クライアントツールのバージョン
         * NuGet クライアントツールの有効な言語です。  これにより、ForceEnglishOutput 設定が使用されている場合、そのことが考慮されます。
         * 既定の要求タイムアウト (プロトコルの既定値よりも優先されます)。
     * 応答には次のものが含まれます。
         * 操作の結果を示す応答コード。  エラーが発生すると、プラグインが終了します。

12.  Log
     * 要求方向: プラグイン-> NuGet
     * 要求には次のものが含まれます。
         * 要求のログレベル
         * ログに記録するメッセージ
     * 応答には次のものが含まれます。
         * 操作の結果を示す応答コード。

13.  NuGet プロセス終了の監視
     * 要求方向:NuGet-> プラグイン
     * 要求には次のものが含まれます。
         * NuGet プロセス ID
     * 応答には次のものが含まれます。
         * 操作の結果を示す応答コード。

14.  プリフェッチパッケージ
     * 要求方向:NuGet-> プラグイン
     * 要求には次のものが含まれます。
         * パッケージ ID とバージョン
         * パッケージソースリポジトリの場所
     * 応答には次のものが含まれます。
         * 操作の結果を示す応答コード

15.  資格情報の設定
     * 要求方向:NuGet-> プラグイン
     * 要求には次のものが含まれます。
         * パッケージソースリポジトリの場所
         * 最後に認識されたパッケージソースのユーザー名 (使用可能な場合)
         * 最後に認識されたパッケージソースパスワード (使用可能な場合)
         * 最後の既知のプロキシユーザー名 (使用可能な場合)
         * 最後に確認されたプロキシパスワード (使用可能な場合)
     * 応答には次のものが含まれます。
         * 操作の結果を示す応答コード

16.  ログレベルの設定
     * 要求方向:NuGet-> プラグイン
     * 要求には次のものが含まれます。
         * 既定のログレベル
     * 応答には次のものが含まれます。
         * 操作の結果を示す応答コード

プロトコルバージョン*2.0.0*メッセージ

17. 操作要求の取得

* 要求方向:NuGet-> プラグイン
    * 要求には次のものが含まれます。
        * パッケージソースのサービスインデックス。
        * パッケージソースリポジトリの場所
    * 応答には次のものが含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合の、サポートされている操作の列挙体。  プラグインでパッケージソースがサポートされていない場合、プラグインはサポートされている操作の空のセットを返す必要があります。

    サービスインデックスとパッケージソースが null の場合、プラグインは認証を使用して応答できます。

18. 認証資格情報の取得

* 要求方向:NuGet-> プラグイン
* 要求には次のものが含まれます。
    * URI
    * isRetry
    * NonInteractive
    * CanShowDialog
* 応答にはが含まれます。
    * Username
    * Password
    * Message
    * 認証の種類の一覧
    * MessageResponseCode
